{% extends "base.html" %}

{% block title %}Matching Songs - WeatherTunes{% endblock %}

{% block content %}
    <h1>Match the Mood</h1>

    <h2>Matching Songs for {{ activity }} in {{ city }}</h2>
    <p>Weather: {{ weather_stats[0] }}Â°F, {{ weather_stats[1] }}</p>

    <ul>
        {% for key, song in songs.items() %}
            <li>{{ song['song_name'] }} by {{ song['artist_name'] }} from the album {{ song['album_name'] }}
            <br>
            <a href="{{ song['song_link'] }}" target="_blank">Listen on Spotify</a>
            
              <input type="hidden" name="song_name" value="{{ song['song_name'] }}">
              <input type="hidden" name="artist_name" value="{{ song['artist_name'] }}">
              <input type="hidden" name="album_name" value="{{ song['album_name'] }}">
              <input type="hidden" name="song_link" value="{{ song['song_link'] }}">
              <button type="submit" class="btn btn-primary save-song-button">Save Song</button>
            </form>
            </li>
        {% endfor %}
    </ul>

    <p>Query Words Used: {{ query_words }}</p>
    
    <a href="{{ url_for('info_for_songs') }}">Change the parameters</a><br>
    <a href="{{ url_for('saved_songs') }}">View Saved Songs</a><br>
    <a href="{{ url_for('dashboard') }}">Back to dashboard</a>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.save-song-form').forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    event.preventDefault();
                    const songId = form.dataset.songId;
                    const button = form.querySelector('.save-song-button');
                    
                    fetch(form.action, {
                        method: form.method,
                        body: new FormData(form),
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    }).then(response => response.json()).then(data => {
                        if (data.status === 'success') {
                            button.textContent = 'Song Saved';
                            button.disabled = true;
                        } else {
                            alert(data.message);
                        }
                    }).catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred. Please try again.');
                    });
                });
            });
        });
    </script>
{% endblock %}
